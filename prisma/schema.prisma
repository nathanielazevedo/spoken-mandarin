generator client {
  provider     = "prisma-client-js"
  engineType   = "driverAdapters"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

model Lesson {
  id           String         @id @default(cuid())
  unitId       String
  order        Int
  name         String
  description  String?
  isUnitFinal  Boolean        @default(false) // True if this is the unit's final exam
  isLevelFinal Boolean        @default(false) // True if this is the level's final exam
  createdAt    DateTime       @default(now())
  updatedAt    DateTime
  unit         Unit           @relation(fields: [unitId], references: [id], onDelete: Cascade)
  sentences    Sentence[]
  userProgress UserProgress[]
  vocabulary   Vocabulary[]
  exam         Exam?

  @@unique([unitId, order])
  @@index([unitId])
}

model Level {
  id          String   @id @default(cuid())
  programId   String
  order       Int
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  program     Program  @relation(fields: [programId], references: [id], onDelete: Cascade)
  units       Unit[]

  @@unique([programId, order])
  @@index([programId])
}

model Program {
  id          String   @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  levels      Level[]
}

model Sentence {
  id       String  @id @default(cuid())
  lessonId String
  pinyin   String
  english  String
  hanzi    String?
  audioUrl String?
  order    Int     @default(0)
  lesson   Lesson  @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([lessonId])
}

model Unit {
  id          String   @id @default(cuid())
  levelId     String
  order       Int
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  lessons     Lesson[]
  level       Level    @relation(fields: [levelId], references: [id], onDelete: Cascade)

  @@unique([levelId, order])
  @@index([levelId])
}

model UserProgress {
  id                String        @id @default(cuid())
  userId            String // Supabase user ID
  lessonId          String
  vocabularyMastery Float         @default(0) // 0-100 percentage
  sentenceMastery   Float         @default(0) // 0-100 percentage
  examPassed        Boolean       @default(false)
  examHighScore     Int? // Best exam score achieved
  completedAt       DateTime? // When lesson was fully completed
  createdAt         DateTime      @default(now())
  updatedAt         DateTime
  lesson            Lesson        @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  examAttempts      ExamAttempt[]

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
}

model ExamAttempt {
  id             String       @id @default(cuid())
  userProgressId String
  score          Int // Percentage score
  passed         Boolean
  timeSpent      Int? // Time in seconds
  answers        Json? // Store answers for review
  createdAt      DateTime     @default(now())
  userProgress   UserProgress @relation(fields: [userProgressId], references: [id], onDelete: Cascade)

  @@index([userProgressId])
}

model Vocabulary {
  id       String  @id @default(cuid())
  lessonId String
  pinyin   String
  english  String
  hanzi    String?
  audioUrl String?
  order    Int     @default(0)
  lesson   Lesson  @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([lessonId])
}

// Exam system
enum QuestionType {
  LISTENING // Play audio, user types what they hear
  TRANSLATE_TO_ENGLISH // Show Chinese, user types English
  TRANSLATE_TO_CHINESE // Show English, user types Chinese (pinyin)
  FILL_BLANK // Sentence with blank, user fills in
  MULTIPLE_CHOICE // Question with 4 options
  SPEAKING // User records themselves saying a phrase
}

model Exam {
  id           String         @id @default(cuid())
  lessonId     String         @unique
  title        String?
  description  String?
  passingScore Int            @default(80) // Percentage needed to pass
  timeLimit    Int? // Time limit in minutes (null = no limit)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime
  lesson       Lesson         @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  questions    ExamQuestion[]
}

model ExamQuestion {
  id             String       @id @default(cuid())
  examId         String
  order          Int
  type           QuestionType
  prompt         String // The question text or reference
  promptAudioUrl String? // Audio for listening questions
  correctAnswer  String // The expected answer
  options        String[] // For multiple choice (array of options)
  explanation    String? // Explanation shown after answering
  points         Int          @default(1)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime
  exam           Exam         @relation(fields: [examId], references: [id], onDelete: Cascade)

  @@unique([examId, order])
  @@index([examId])
}
